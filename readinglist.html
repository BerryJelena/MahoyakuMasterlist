<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Translation Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load jQuery (required for Isotope) and Isotope Layout -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/isotope-layout@3/dist/isotope.pkgd.min.js"></script>
    <!-- Load Phosphor Icons for UI elements -->
    <script src="https://unpkg.com/phosphor-icons"></script>
    
    <style>
        /* Configure Tailwind to use Inter font and apply base styling */
        body {
            font-family: "Montserrat", sans-serif;
            background-color: #f5f4fa;
            color: #481c58;
        }

        /* The new top header/menu styling */
        .header {
            /* Using Tailwind classes for sticky, shadow, and background */
            border-bottom: 1px solid #e1d8e6;
        }

        /* Event Grid Item Styling */
        .item {
            /* Margin update: Using 0.75rem (approx 0.7em) for all sides */
            margin: 0.75rem; 
            margin-bottom: 1.5rem; /* Keep existing bottom margin for vertical spacing */
            border-radius: 0.75rem;
            background-color: #e1def5;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent; /* Base state border */
        }
        
        .item:hover {
             transform: translateY(-2px);
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        /* Collected State (Added for tracking) */
        .collected-item {
            border-color: #a9c447; /* Emerald border for collected item */
            background-color: #d0e4a9; /* Light green background */
        }

        .box img {
            width: 100%;
            height: auto;
            /* Updated border radius for full-width banner */
            border-radius: 0.75rem 0.75rem 0 0;
        }
        
        /* Isotope item sizing for responsiveness, adjusted for 1.5rem total horizontal margin (0.75rem * 2) */
        .grid-sizer, .item { width: calc(100% - 1.5rem); }
        @media (min-width: 640px) {
            .grid-sizer, .item { width: calc(50% - 1.5rem); }
        }
        @media (min-width: 1024px) {
            .grid-sizer, .item { width: calc(33.3333% - 1.5rem); }
        }
        
        /* Custom Modal Styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body>

    <!-- ====================================================================
         HEADER (New Sticky Top Menu)
         ==================================================================== -->
    <header id="topHeader" class="header bg-white p-4 sticky top-0 z-40 shadow-md">
        <div class="max-w-7xl mx-auto flex flex-col lg:flex-row justify-between items-start lg:items-center">
            
            <!-- Logo & Links Group -->
            <div class="flex flex-col lg:flex-row lg:space-x-8 w-full lg:w-auto mb-4 lg:mb-0">
                <h1 class="text-2xl font-bold mb-2 lg:mb-0">Masterlist Tracker</h1>
            </div>

            <!-- Progress Tracker & Reset Group (Horizontal on desktop, stacked on mobile) -->
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 w-full lg:w-auto">
                <!-- Links -->
                <div class="flex space-x-4 text-gray-600 mb-2 lg:mb-0 items-center">
                    <a href="4koma.html" class="hover:text-blue-500" title="4Koma"><i class="ph-arrow-u-down-left text-xl"></i></a>
                    <a href="https://mhykmasterlist.tumblr.com/" target="_blank" class="hover:text-blue-500" title="Contact"><i class="ph-envelope-fill text-xl"></i></a>
                    <a href="https://docs.google.com/spreadsheets/d/1MgcUjuoKyMkxDt715843NLYXpl6N5hbob8kAQ8-y7VY/edit?usp=sharing" target="_blank" class="hover:text-blue-500" title="Spreadsheet"><i class="ph-sparkle-fill text-xl"></i></a>
                    <a href="https://buymeacoffee.com/maripe" target="_blank" class="hover:text-blue-500" title="Support"><i class="ph ph-coffee text-xl"></i></a>
                </div>
                <!-- Progress Tracker Section -->
                <div class="p-3 bg-gray-50 rounded-lg shadow-inner flex-grow">
                    <h3 class="text-xs font-semibold text-gray-500 mb-1">My Reading Progress</h3>
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold text-gray-700">
                            <span id="collectedCount">0</span> / <span id="totalCount">0</span> Read
                        </span>
                        <span class="text-sm font-bold text-emerald-600 ml-4" id="progressPercentage">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1">
                        <div id="progressBar" class="bg-emerald-500 h-1.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Reset Button -->
                <button id="resetButton" class="w-full sm:w-auto px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150 flex-shrink-0">
                    Reset Progress
                </button>
            </div>
            
        </div>
    </header>

    <!-- ====================================================================
         MAIN CONTENT (Event Grid) - Now occupies the full width below the header
         ==================================================================== -->
    <div class="content p-4 lg:p-8 max-w-7xl mx-auto">
        <h2 id="initialStatus" class="text-xl text-center loading-text text-blue-500">Loading masterlist data from Google Sheet...</h2>
        
        <section class="grid mt-8" id="event-grid">
            <!-- The grid-sizer ensures Isotope calculates columns correctly -->
            <div class="grid-sizer"></div>
            <!-- Event items are inserted here by JavaScript -->
        </section>
    </div>


    <!-- Floating Message Box (Toast) -->
    <div id="messageBox" class="fixed top-4 right-4 bg-emerald-500 text-white px-6 py-3 rounded-xl shadow-lg transform translate-x-full transition-transform duration-300 z-50" role="alert">
        <span id="messageText"></span>
    </div>

    <!-- Custom Reset Confirmation Modal -->
    <div id="resetModal" class="hidden fixed inset-0 flex items-center justify-center modal-overlay z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-bold text-red-600 mb-3 flex items-center">
                <i class="ph-fill ph-warning-circle text-2xl mr-2"></i> Confirm Reset
            </h3>
            <p class="text-gray-700 mb-6">
                Are you absolutely sure you want to reset all reading progress? This action cannot be undone and will clear the saved status for all events.
            </p>
            <div class="flex justify-end space-x-3">
                <button id="cancelReset" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg font-semibold hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button id="confirmResetButton" class="px-4 py-2 text-white bg-red-500 rounded-lg font-semibold hover:bg-red-600 transition">
                    Yes, Reset Everything
                </button>
            </div>
        </div>
    </div>
    <!-- End Custom Reset Confirmation Modal -->

    <!-- ====================================================================
         JAVASCRIPT LOGIC (Data, Tracking, and Interaction)
         ==================================================================== -->
    <script>
        
        // --- 1. SETUP & CONFIGURATION ---
        
        // Data for mapping character names to IDs (No longer used for filters, but kept for data integrity/potential future use)
        const characterToId = [
            { chara: "oz", id: 1 }, { chara: "arthur", id: 2 }, { chara: "cain", id: 3 },
            { chara: "riquet", id: 4 }, { chara: "snow", id: 5 }, { chara: "white", id: 6 },
            { chara: "mithra", id: 7 }, { chara: "owen", id: 8 }, { chara: "bradley", id: 9 },
            { chara: "faust", id: 10 }, { chara: "shino", id: 11 }, { chara: "heathcliff", id: 12 },
            { chara: "nero", id: 13 }, { chara: "shylock", id: 14 }, { chara: "murr", id: 15 },
            { chara: "chloe", id: 16 }, { chara: "rustica", id: 17 }, { chara: "figaro", id: 18 },
            { chara: "rutile", id: 19 }, { chara: "lennox", id: 20 }, { chara: "mitile", id: 21 },
            { chara: "akira", id: 22 }, { chara: "cockrobin", id: 23 },
        ];
        
        // Data for mapping year numbers to filter names (No longer used for filters)
        const yearToId = [
            { year: "first", id: "1" }, { year: "second", id: "2" }, { year: "third", id: "3" },
            { year: "fourth", id: "4" }, { year: "fifth", id: "5" }, { year: "sixth", id: "6" },
        ];

        // Google Sheet Configuration 
        const sheetId = "1SHxrt80OQj4RfjnhmkFiGI_pLr03F-f6DUlBoOlsONU";
        const sheetName = encodeURIComponent("Output_(Events)");
        const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;
        
        // Local Storage Key for storing collected status
        const COLLECTION_ITEMS_KEY = 'mahoyakuTrackerStatus'; 

        // Global state variables
        let allItems = []; 
        let selectedEventIds = []; 
        let $grid; 

        // References to DOM elements
        const collectionContainer = document.getElementById('event-grid');
        const resetButton = document.getElementById('resetButton');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const initialStatus = document.getElementById('initialStatus');
        const collectedCountSpan = document.getElementById('collectedCount');
        const totalCountSpan = document.getElementById('totalCount');
        const progressPercentageSpan = document.getElementById('progressPercentage');
        const progressBarDiv = document.getElementById('progressBar');
        
        // Modal references
        const resetModal = document.getElementById('resetModal');
        const confirmResetButton = document.getElementById('confirmResetButton');
        const cancelReset = document.getElementById('cancelReset');
        
        // SVG Icons for visual status (Checkmark and Blank Box)
        const CHECKMARK_SVG = `<i class="ph-fill ph-check-circle text-emerald-600 text-3xl"></i>`;
        const BLANK_BOX_SVG = `<i class="ph-regular ph-circle text-gray-400 text-3xl"></i>`;
        
        // --- 2. UTILITY FUNCTIONS (CSV PARSING) ---
        
        /** Converts CSV string data into an array of objects. */
        function csvToObjects(csv) {
            const csvRows = csv.split("\n").filter(row => row.trim() !== '');
            if (csvRows.length === 0) return [];
            
            const propertyNames = csvSplit(csvRows[0]); 
            let objects = [];
            for (let i = 1, max = csvRows.length; i < max; i++) {
                let thisObject = {};
                let row = csvSplit(csvRows[i]);
                for (let j = 0, max = row.length; j < max; j++) {
                    // Use a unique ID for tracking based on array index
                    thisObject['id'] = i; 
                    thisObject[propertyNames[j]] = row[j];
                }
                objects.push(thisObject);
            }
            return objects;
        }
        
        /** Splits a CSV row by commas and removes surrounding quotes. */
        function csvSplit(row) {
            // This regex handles quoted fields containing commas
            const matches = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
            return matches ? matches.map(val => val.trim().replace(/^"|"$/g, '')) : [];
        }

        // --- 3. PERSISTENCE (LOCAL STATUS) FUNCTIONS ---

        function loadCollectedStatus() {
            try {
                const storedData = localStorage.getItem(COLLECTION_ITEMS_KEY);
                selectedEventIds = storedData ? JSON.parse(storedData).map(Number) : [];
            } catch (error) {
                console.error("Could not load collection status from localStorage:", error);
                selectedEventIds = [];
            }
        }

        function saveCollectedStatus() {
            try {
                localStorage.setItem(COLLECTION_ITEMS_KEY, JSON.stringify(selectedEventIds));
            } catch (error) {
                console.error("Could not save collection status to localStorage:", error);
            }
        }

        // --- 4. PROGRESS TRACKER & MESSAGING ---

        function updateTracker() {
            const total = allItems.length;
            const collected = selectedEventIds.length;
            
            collectedCountSpan.textContent = collected;
            totalCountSpan.textContent = total;

            const percentage = total > 0 ? Math.round((collected / total) * 100) : 0;
            
            progressPercentageSpan.textContent = `${percentage}%`;
            progressBarDiv.style.width = `${percentage}%`;
        }

        function showMessage(text, isError = false) {
            messageText.textContent = text;
            messageBox.classList.remove('translate-x-full'); 
            messageBox.classList.remove('bg-emerald-500', 'bg-red-500');
            // Use different color for positive/negative change, or just keep green for success/action
            messageBox.classList.add(isError ? 'bg-red-500' : 'bg-emerald-500');
            
            setTimeout(() => {
                messageBox.classList.add('translate-x-full');
            }, 3000);
        }

        // --- 5. DATA FETCHING & RENDERING CORE ---
        
        async function fetchAndRenderEvents() {
            try {
                const response = await fetch(sheetURL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}. Check sheet publication.`);
                }
                const csvText = await response.text();
                
                // 1. Process Data
                allItems = csvToObjects(csvText).filter(item => item.Event_Name && item.Event_Name.trim() !== '');

                // 2. Load Local Status
                loadCollectedStatus(); 

                // 3. Build HTML for Isotope Grid
                let html = '';
                allItems.forEach(item => {
                    html += createItemElement(item);
                });
                
                collectionContainer.innerHTML = html;
                
                // 4. Initialize Isotope
                initializeIsotope();
                
                // 5. Update Tracker
                updateTracker();
                
                // Remove loading status
                initialStatus.style.display = 'none';


            } catch (error) {
                console.error("Fatal Error:", error);
                initialStatus.textContent = `Error loading data: ${error.message}. Please check the Google Sheet URL and ensure it is published to the web in CSV format.`;
                initialStatus.className = "text-xl text-center error-text text-red-500 mt-8";
            }
        }
        
        /** Creates the HTML string for a single event card. */
        function createItemElement(item) {
            // Item ID is used as the tracking key
            const itemId = Number(item.id); 
            const isCollected = selectedEventIds.includes(itemId);
            const collectedClass = isCollected ? 'collected-item' : '';
            
            // Clean up and format data
            // FIX: Replaced underscores with spaces, then replaced dollar signs with comma/space.
            const eventName = item.Event_Name.replaceAll("_", " ").replaceAll("$", ", ").trim();
            const characters = item.Character.replaceAll("-", ", ").trim();
            const writer = item.Writer.trim();
            
            // Build filter classes (still included in the item for potential future filtering or sorting)
            const yearObj = yearToId.find(y => y.id === item.Year);
            const yearClass = yearObj ? yearObj.year : 'unknown-year';
            const tlClass = item.TL === "TRUE" ? 'tl' : 'notl';
            const characterClasses = item.Character.toLowerCase().split('-').join(' ');
            const storyTypeClass = item.Story.toLowerCase().trim();
            const countryClass = item.Country.toLowerCase().trim();
            
            const filterClasses = `${storyTypeClass} ${yearClass} ${countryClass} ${characterClasses} ${tlClass}`;

            // Render the card structure (Vertical layout)
            return `
                <div class="item p-0 ${filterClasses} ${collectedClass} transition-all duration-300" 
                     data-id="${itemId}"
                     onclick="handleItemClick(event)">
                    
                    <!-- Image Box (Now full width) -->
                    <div class="box w-full">
                         <!-- Using a unique placeholder color based on ID to simulate different banners -->
                         <img src="root/assets/banner/${itemId * 10 % 100}4444?text=Event+${itemId}" 
                              alt="${eventName} Banner" 
                              class="w-full h-auto object-cover">
                    </div>
                    
                    <!-- Content Section -->
                    <div class="content-text p-4">
                        <!-- break-words CLASS ensures long titles wrap cleanly -->
                        <h2 class="text-xl font-extrabold text-gray-900 mb-1 break-words">${eventName}</h2>
                        <i class="text-sm text-gray-500 block mb-2">Written by ${writer}</i>
                        
                        <table class="table-auto text-sm mb-2 w-full">
                            <tr class="text-gray-600 font-semibold border-b">
                                <td>Chapters</td>
                                <td class="text-right">Release</td>
                            </tr>
                            <tr class="text-gray-800">
                                <td>${item.Chapters || '-'}</td>
                                <td class="text-right">${item.Release || '-'}</td>
                            </tr>
                        </table>
                        
                        <!-- Status Icon moved up -->
                        <div class="flex justify-between items-center pt-2 mt-2 border-t border-gray-100">
                            <p class="text-sm text-gray-700">
                                <b class="font-bold">Characters:</b> ${characters}
                            </p>
                            <div class="status-icon">${isCollected ? CHECKMARK_SVG : BLANK_BOX_SVG}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Filter rendering removed, as filters are removed from HTML

        /** Initializes and binds the Isotope grid (without filters). */
        function initializeIsotope() {
            // Use jQuery to initialize Isotope on the grid
            $grid = $(collectionContainer).isotope({
                itemSelector: ".item", 
                percentPosition: true,
                layoutMode: 'fitRows', // Ensures items are laid out cleanly
                filter: '*' // Default to show all items
            });
        }


        // --- 6. INTERACTION LOGIC ---

        /** Toggles the collected status of an event item. */
        function handleItemClick(event) {
            const target = event.target;
            if (target.tagName === 'A' || target.closest('a')) {
                return;
            }

            const itemDiv = event.currentTarget;
            const itemId = parseInt(itemDiv.getAttribute('data-id')); 
            // itemName is no longer needed for the simplified message, but left here in case it's used elsewhere later.
            // const itemName = allItems.find(i => i.id === itemId)?.Event_Name.replaceAll("_", " ").replaceAll("$", ", ") || `Event ID ${itemId}`;

            const isCurrentlyCollected = itemDiv.classList.contains('collected-item');
            const statusIconContainer = itemDiv.querySelector('.status-icon');

            if (isCurrentlyCollected) {
                // DESELECT LOGIC
                selectedEventIds = selectedEventIds.filter(id => id !== itemId);
                itemDiv.classList.remove('collected-item');
                statusIconContainer.innerHTML = BLANK_BOX_SVG;
                // Updated message to -1 Event
                showMessage("-1 Event");
            } else {
                // SELECT LOGIC
                selectedEventIds.push(itemId);
                itemDiv.classList.add('collected-item');
                statusIconContainer.innerHTML = CHECKMARK_SVG;
                // Updated message to +1 Event
                showMessage("+1 Event");
            }
            
            saveCollectedStatus(); 
            updateTracker(); 
            if ($grid) $grid.isotope('layout');
        }

        // --- Custom Modal Functions ---

        /** Shows the custom reset confirmation modal. */
        function showResetModal() {
            resetModal.classList.remove('hidden');
        }
        
        /** Hides the custom reset confirmation modal. */
        function closeResetModal() {
            resetModal.classList.add('hidden');
        }

        /** Executes the actual reset logic after confirmation. */
        function performReset() {
            selectedEventIds = [];
            
            saveCollectedStatus();
            
            document.querySelectorAll('.item').forEach(itemDiv => {
                itemDiv.classList.remove('collected-item');
                const statusIconContainer = itemDiv.querySelector('.status-icon');
                if (statusIconContainer) {
                    statusIconContainer.innerHTML = BLANK_BOX_SVG;
                }
            });
            
            updateTracker(); 
            // Keep the reset message clear and verbose
            showMessage("Reading progress successfully reset!", true);
            
            closeResetModal();
        }

        // --- 7. INITIALIZATION ---
        
        function initializeApp() {
            // Bind the button to show the modal
            resetButton.addEventListener('click', showResetModal);
            
            // Bind modal buttons to actions
            cancelReset.addEventListener('click', closeResetModal);
            confirmResetButton.addEventListener('click', performReset);
            
            // Start the data fetching and rendering process
            fetchAndRenderEvents();
        }

        window.onload = initializeApp;
        
    </script>
</body>
</html>